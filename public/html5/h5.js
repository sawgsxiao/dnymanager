$(function(){var e={init:function(){var e=this;require(["swipe"],function(){var t=$("#position li");if(t.length<=1){$("#position").css("display","none");$(".swipe").css({visibility:"visible"});$(".image").css("left","0px")}else{$("#slider").Swipe({continuous:true,callback:function(e){var n=t.length;while(n--){t[n].className=" "}t[e].className="on"}}).data("Swipe")}e.bindEvent()})},bindEvent:function(){var e=this;e.$departureDateTxt=$("#departureDateTxt");e.$departureDateDown=$("#departureDateDown");var t=e.$departureDateTxt.children("p").height();var n=parseInt(e.$departureDateTxt.css("max-height"),10);if(t>n){e.$departureDateDown.show();e.$departureDateDown.on(qyerUtil.EVENT.CLICK,function(){if(e.$departureDateTxt.hasClass("up")){e.$departureDateTxt.addClass("down").removeClass("up").animate({"max-height":t+"px"},50);e.$departureDateDown.addClass("departureDateUp").html("收起全部")}else{e.$departureDateTxt.addClass("up").removeClass("down").animate({"max-height":n+"px"},50);e.$departureDateDown.removeClass("departureDateUp").html("查看全部")}})}$(".productInfoTilC").on(qyerUtil.EVENT.CLICK,function(){var e=$(this).siblings(),t=e.children().height();if(e.css("height")=="0px"){e.animate({height:t},300);$(this).addClass("productInfoTilC2")}else{e.animate({height:"0px"},300);$(this).removeClass("productInfoTilC2")}});if($("#collectBtn").length){$("#collectBtn").click(function(){e.addCollect($(this))})}if($(".fixedBar").length){$("#fixedBar .tellme").on("click",function(){e.tellmeClick($(this))})}if($(".fixedBar").length){$("#fixedBar .booking:not(.soldout):not(.finished)").on("click",function(){e.bookingClick($(this))})}$("#js_closePopup").on("click",function(){$("#js_popupBox").hide()});$("#lm_popup_close").click(function(){$(".lm_popupbg").hide()})},addCollect:function(e){if(e.hasClass("favoring"))return false;if(!qyerUtil.isLogin()){qyerUtil.doLogin();return false}e.addClass("favoring");if(e.hasClass("qui-icon-heart2")){$.ajax({url:"/api.php?action=lmfavor",type:"post",data:{deal_id:$("#lid").val()},dataType:"json",success:function(t){if("ok"==t.result){e.addClass("qui-icon-heart-reverse").removeClass("qui-icon-heart2")}e.removeClass("favoring")},error:function(){require(["slidTip"],function(e){e.show({type:5,text:"收藏失败"})});e.removeClass("favoring")}})}else{$.ajax({url:"/api.php?action=lmfavor",data:"deal_id="+$("#lid").val()+"&op=del",dataType:"json",success:function(t){if("ok"==t.result){e.addClass("qui-icon-heart2").removeClass("qui-icon-heart-reverse")}e.removeClass("favoring")},error:function(){require(["slidTip"],function(e){e.show({type:5,text:"取消收藏失败"})});e.removeClass("favoring")}})}},tellmeClick:function(e){if(!qyerUtil.isLogin()){qyerUtil.doLogin();return false}if(!e.hasClass("done")){e.addClass("done");$.ajax({url:"/api.php?action=lm_subscribe_single",type:"post",data:{lid:$("#lid").val()},dataType:"json",async:false,success:function(t){if(typeof t.error_code!="undefined"&&t.error_code==0){e.html("已设置提醒");require(["slidTip"],function(e){e.show({type:1,text:"提醒设置成功"})})}else{e.removeClass("done");require(["slidTip"],function(e){e.show({type:1,text:"提醒设置失败"})})}}})}},bookingClick:function(e){if(e.hasClass("notstart"))return false;if(this.is_weixin()){$("#js_popupBox").show();return false}if(typeof e.attr("data-login-visible")!="undefined"){if(!qyerUtil.isLogin()&&e.attr("data-login-visible")=="1"){qyerUtil.doLogin();return}}if(e.hasClass("booktype")){setOrderform($("#lid").val())}else{$(".lm_popupbg").show();var t=($(window).height()-$(".lm_popup").height())/2;if(t<0){t=0}$(".lm_popupbg .lm_popup").css("top",t+"px")}},is_weixin:function(){var e=navigator.userAgent.toLowerCase();if(e.match(/MicroMessenger/i)=="micromessenger"){return true}else{return false}}};if($("#detailMainBar").length){e.init()}var t={init:function(){var e=this;this.bindEvent()},bindEvent:function(){var e=this;this.$maTabList=$("#maTabList");var t=$("#maContenBar .maContenBox");this.$maTabList.children("li").eq(0).addClass("current").siblings().removeClass("current");t.eq(0).show().siblings().hide();this.$maTabList.children("li").on("click",function(){var e=$(this).index();$(this).addClass("current").siblings().removeClass("current");t.eq(e).show().siblings().hide()});document.getElementById("maTabList").addEventListener("touchstart",function(e){a(e)},false);document.getElementById("maTabList").addEventListener("touchmove",function(e){f(e)},false);document.getElementById("maTabList").addEventListener("touchend",function(e){l(e)},false);var n,r,i,s=0,o=1,u=0;var a=function(t){if(o){for(var r=0;r<e.$maTabList.children("li").length;r++){s+=e.$maTabList.children("li").eq(r).width()}o=0;e.$maTabList.width(s);if(s>$(window).width()){u=-(s-$(window).width())}}var a=t.touches?t.touches[0]:t;n=a.pageX;i=e.$maTabList.position().left};var f=function(t){var s=t.touches?t.touches[0]:t;r=s.pageX;var o=r-n+i;if(o>0){o=0}if(o<u){o=u}e.$maTabList.css("left",o)};var l=function(){}}};if($("#maMain").length){t.init()}var n={passLen:0,pop:null,tpl:null,regConfig:null,data:{},_curr:null,proxy:$({}),ajaxUrl:{savePassUrl:"/z/?action=savetraveler"},popupWaitHtml:['<div class="lmPopWrapper">','<div class="lmPopInner">','<div class="closeWarp clearfix">X</div>','<img width="194px" height="226px" src="http://static.qyer.com/m/project/lm/images/img_wait.png" />',"</div>","</div>"].join(""),popupSoldoutHtml:['<div class="lmPopWrapper">','<div class="lmPopInner">','<div class="ico"></div>',"<p>产品已售罄，请选择其他产品</p>",'<a class="lv know" href="javascript:void(0)">我知道了</a>',"</div>","</div>"].join(""),init:function(){var e=this;require(["popup_base","project/m/lmMobile/detail/js/validateConfig","project/m/lmMobile/detail/js/util","project/m/lmMobile/detail/js/order_coupons","project/m/lmMobile/detail/js/calendar"],function(t,n,r,i){e.pop=t;e.util=r;e.regConfig=n;e.bindEvent();e._lmCalendar=new lmCalendar;$("#amount").val(0);$("#roomNum").val(0);e._coupons=new i})},bindEvent:function(){var e=this;$("body,document").on(qyerUtil.EVENT.CLICK,".itemType .combo",function(t){e.evt_combo_click(t)}).on(qyerUtil.EVENT.CLICK,"#amountNumBox .add",function(t){e.evt_add_click(t)}).on(qyerUtil.EVENT.CLICK,"#amountNumBox .subtract",function(t){e.evt_subtract_click(t)}).on(qyerUtil.EVENT.CLICK,"#roomNumBox .add",function(t){e.evt_rAdd_click(t)}).on(qyerUtil.EVENT.CLICK,"#roomNumBox .subtract",function(t){e.evt_rSubtract_click(t)}).on(qyerUtil.EVENT.CLICK,"#submitOrder",function(t){e.evt_submitOrder_click(t)}).on(qyerUtil.EVENT.CLICK,".passenger-box",function(t){e.evt_edit_passenger(t)}).on(qyerUtil.EVENT.CLICK,".js-show-del-btn",function(t){e.evt_showdelBtn_click(t)}).on(qyerUtil.EVENT.CLICK,".js-pop-head-comm-confirm",function(t){e.evt_pop_comm_confirm(t)}).on(qyerUtil.EVENT.CLICK,".js-pop-head-pass-confirm",function(t){e.evt_pop_pass_confirm(t)}).on(qyerUtil.EVENT.CLICK,".js-pop-head-back",function(t){e.evt_pop_back(t)}).on(qyerUtil.EVENT.CLICK,".js-pop-head-pass-back",function(t){e.evt_pop_pass_back(t)}).on(qyerUtil.EVENT.CLICK,".js-pop-edit",function(t){e.evt_pop_edit_comm_pass(t)}).on(qyerUtil.EVENT.CLICK,".js-pop-add-pass",function(t){e.evt_pop_addPass("1")}).on(qyerUtil.EVENT.CLICK,".js-pop-save-pass-btn",function(t){e.evt_pop_savePass(t)}).on(qyerUtil.EVENT.CLICK,".pass-tip",function(t){e.evt_pop_passTip(t)}).on(qyerUtil.EVENT.CLICK,".close-tip",function(t){e.evt_pop_close_passTip(t)}).on(qyerUtil.EVENT.CLICK,".input-text",function(t){e.evt_pop_input(t)}).on("focus",".input-text",function(t){e.evt_pop_input_focus(t)}).on("change",".input-select",function(t){e.change_identityType(t)});$(".itemType .combo.selected").removeClass("selected").trigger(qyerUtil.EVENT.CLICK);$(".js-add-passenger").on(qyerUtil.EVENT.CLICK,function(t){e.evt_addPassenger_click(t)});$("#contactMessage").on({focus:function(){$("body").height($("body").height()+100);$("body,html").scrollTop(9999)},blur:function(){$("body").height($("body").height()-100)}});$(".lmOrderForm .itemIpt input").on({focus:function(e){n.evt_itemIpt_focus(e)},blur:function(e){n.evt_itemIpt_blur(e)}});$("#itemDepart").on(qyerUtil.EVENT.CLICK,function(t){var r=$(".itemType .selected").attr("data-pid");if(!n.data[r])return false;e._lmCalendar.show({_data:n.data[r],proxy:e.proxy,onOK:function(t){t.stock=t.remain;if(parseFloat(t.room_diff)<=0){$("#roomNumBar").hide()}else{$("#roomNumBox .subtract,#roomNumBox .add").addClass("disable");$("#roomNum").val(1);$("#roomNumBar").show()}e.setCurr(t)}})});$("#contactTravelTimeStart").change(function(){$("#contactTravelTimeEnd").attr("min",$(this).val())});$("#contactTravelTimeEnd").change(function(){$("#contactTravelTimeStart").attr("max",$(this).val())});$("#contactTravelTimeStart").attr("max",$("#contactTravelTimeEnd").val());$("#contactTravelTimeEnd").attr("min",$("#contactTravelTimeStart").val());e.proxy.on("reset_coupons_val",function(){e._coupons&&e._coupons.reset_coupons_val(true)})},getStamp:function(){return(new Date).valueOf()+""},setCurr:function(e){var t=this;this._curr=e;if(this._curr===null){$("#depart").val("");$("#lmcid").val("");$("#amount").val(1);$("#amountNumBox .subtract").addClass("disable");$("#amountNumBox .add").addClass("disable");this.getPrice(1);return false}if(e.buy_limit>0){this._curr.usernum=parseInt(e.already_buy);var n=parseInt(this._curr.buy_limit)-parseInt(this._curr.usernum);this._curr.limitNum=n;this.initPerson(n)}else{this.initPerson(this._curr.stock)}$("#lmcid").val(this._curr.cid);this.getPrice(1);return this},initPerson:function(e){var t=$("#amount");var n=$("#amountNumBox .subtract");var r=$("#amountNumBox .add");if(e>1){t.val(1);n.addClass("disable");r.removeClass("disable")}else if(e==1){t.val(1);n.addClass("disable");r.addClass("disable")}else if(e==0){t.val(0);n.addClass("disable");r.addClass("disable");$("#roomNumBar").hide()}},getCurr:function(){return this._curr},getPrice:function(e){var t=0;if(this._curr!==null){var n=parseInt($("#amount").val());t=parseFloat(n*this._curr.price);var r=parseInt(this._curr.room_type);var i=parseFloat(this._curr.room_diff);if(this._curr.room_type&&this._curr.room_diff){e=parseInt(e);var s=(e*r-n)*i;this.setRoomOffset(s);t+=s}t=Math.round(t*100)/100}$("#lmTotPrice").val(t);$("#lmTotPrice").triggerHandler("change")},setRoomOffset:function(e){if(e>0){$("#roomOffset").show().find("span").html("¥"+e);$("#roomOffsetBar2").show();$("#roomOffset2").html(e)}else{$("#roomOffset").hide();$("#roomOffsetBar2").hide()}},evt_pop_back:function(){this.pop.hide()},evt_pop_pass_back:function(e){var t,n,r;t=$(e.currentTarget);n=t.attr("data-goback");r=t.parents(".pop-info-wrap").attr("data-popname");this.pop.hide();if(n&&n=="1"){this.evt_addPassenger_click()}t=n=null},evt_pop_pass_confirm:function(e){var t,n,r,i,s,o,u,a;s=$(e.currentTarget);t=$(".passenger-list li");n=this.util.passengerValidate(t);if(n){require(["slidTip"],function(e){e.show({type:5,text:"信息填写有误，请核查！"})})}else{r=s.parents(".pop-info-wrap").attr("data-popName");a=this.util.getAjaxData(t);a.id=t.attr("data-id");switch(r){case"添加新旅客":u={id:a.id,stamp:this.getStamp(),index:this.passLen,data:a};this.util.addNewPagePassenger(u);this.passLen+=1;break;case"编辑旅客信息":a.stamp=t.attr("data-stamp");var o,f;o=$('.hidden-pass-list li[data-stamp="'+a.stamp+'"]');f=$('.passenger-box[data-stamp="'+a.stamp+'"]');o.replaceWith(t);this.util.updatePassName(f,a);o=f=null;break}this.pop.hide()}t=n=r=i=s=o=u=null},evt_pop_comm_confirm:function(e){var t,n,r,i,s,o;t=this;n=$(e.currentTarget);s=$(".pop-passenger-list li .input-passenger");o=$(".pop-passenger-list li .input-passenger:checked");r=parseInt($("#amount").val());i=$(".passenger-name-list li").length;data=[];s.each(function(e){var t=$(this).attr("data-id");var n=$('.passenger-name-list .passenger-box[data-id="'+t+'"]');if(n.length>0){if(!$(this).prop("checked")){i-=1}}else{if($(this).prop("checked")){i+=1}}});if(i>r){require(["slidTip"],function(e){e.show({type:5,text:"旅客人数超出！"})});return false}if(o.length>0){s.each(function(e){var n=$(this).attr("data-id");var r=$('.passenger-name-list .passenger-box[data-id="'+n+'"]');if($(this).prop("checked")){if(r.length<=0){data.push(t.util.getPassSingelData(passenger,n))}}else{t.util.delPagePassenger(n)}});for(var u=0,i=data.length;u<i;u++){var a={id:data[u].id,stamp:this.getStamp(),index:this.passLen,data:data[u]};this.util.addNewPagePassenger(a);this.passLen+=1;a=null}t.pop.hide()}else{require(["slidTip"],function(e){e.show({type:5,text:"请选择旅客信息！"})})}t=n=r=i=o=null},savePassengerAjax:function(e){e.posturl=this.ajaxUrl.savePassUrl;qyerUtil.doAjax(e)},do_savePassengerAjax:function(e,t){var n=this;this.savePassengerAjax({data:e,onSuccess:function(r){if(r.data&&r.data.id){e.id=r.data.id;passenger=n.util.updatePassengerModel(passenger,e);require(["slidTip"],function(e){e.show({type:1,text:"保存成功！"})});if($.isFunction(t))t(e)}else{require(["slidTip"],function(e){e.show({type:5,text:"数据错误！"})})}},onError:function(e){if(e.__server_error__){require(["slidTip"],function(e){e.show({type:5,text:"服务器错误，请稍后再试！"})})}else{require(["slidTip"],function(t){t.show({type:5,text:e.data.msg||"未知错误"})})}}})},evt_pop_savePass:function(e){var t,n,r,i,s,o;t=$(e.currentTarget);if(t.hasClass("disable")){return}o=this;n=$(".passenger-list li");r=this.util.passengerValidate(n);t.addClass("disable");if(r){require(["slidTip"],function(e){e.show({type:5,text:"信息填写有误，请核查！"})});t.removeClass("disable")}else{s=t.attr("data-id")||"0";i=this.util.getAjaxData(n);i.id=s;this.do_savePassengerAjax(i,function(e){var n,r,s,u;n=i.id;r=$(".pop-info-wrap").attr("data-popname");s=$('.passenger-box[data-id="'+n+'"]');u=$('.hidden-pass-list li[data-id="'+e.id+'"]');if(r=="编辑常用旅客信息"){if(s.length>0){o.util.updatePassenger(u,i);o.util.updatePassName(s,i)}}t.removeClass("disable");n=r=s=u=null})}},evt_pop_addPass:function(e){var t,n,r,i,s,o;n=this;r=parseInt($("#amount").val());i=$(".passenger-name-list li").length;if(i>=r){require(["slidTip"],function(e){e.show({type:5,text:"旅客人数超出！"})});return}t=parseInt($(".hidden-pass-list li:last").attr("data-index"))+1||0;s={stamp:this.getStamp(),index:t};o={id:0,goback:e?e:"",logoText:"添加新旅客"};this.util.showPopPassenger("添加新旅客",this.pop,s,o);t=n=r=i=s=o=null},evt_addPassenger_click:function(e){var t,n,r,i;t=parseInt($("#amount").val());n=$(".passenger-name-list li").length;if(n>=t){require(["slidTip"],function(e){e.show({type:5,text:"旅客人数超出！"})});return}if(passenger&&passenger.length>0){r=[];$(".hidden-pass-list li").each(function(e){r.push($(this).attr("data-id"))});i={id:r,data:passenger};this.util.showCommonPassenger(this.pop,i)}else{this.evt_pop_addPass()}t=n=r=i=null},evt_pop_edit_comm_pass:function(e){var t,n,r,i,s;t=$(e.currentTarget);r=t.attr("data-id");$li=$('.hidden-pass-list li[data-id="'+r+'"]');if($li.length>0){n=$li.attr("data-stamp");i={stamp:n};s={id:r,goback:"1",logoText:"编辑常用旅客信息"};this.util.showPopPassenger("编辑旅客信息",this.pop,i,s)}else{i={id:r,index:0,data:this.util.getPassSingelData(passenger,r)};s={id:r,goback:"1",logoText:"编辑常用旅客信息"};this.util.showPopPassenger("编辑常用旅客信息",this.pop,i,s)}},evt_edit_passenger:function(e){var t,n;t=$(e.currentTarget);n=t.attr("data-stamp");id=t.attr("data-id")||0;if($(e.target).hasClass("js-show-del-btn")||$(e.target).hasClass("icon-del")){return false}option1={stamp:n};option2={id:id,logoText:"编辑旅客信息"};this.util.showPopPassenger("编辑旅客信息",this.pop,option1,option2);t=n=null},evt_pop_passTip:function(){var e;e=this.util.getPassengerTip();$("body").append(e)},evt_pop_close_passTip:function(){$(".pop-pass-tip").remove()},del_passenger:function(e,t){var n;if(t){n=confirm("确定要删除此联系人吗？");if(n){$('.hidden-pass-list li[data-stamp="'+e+'"]').remove();$('.passenger-name-list li[data-stamp="'+e+'"]').remove()}}else{$('.hidden-pass-list li[data-stamp="'+e+'"]').remove();$('.passenger-name-list li[data-stamp="'+e+'"]').remove()}n=null},evt_showdelBtn_click:function(e){var t,n;t=$(e.currentTarget).parents(".passenger-box");n=t.attr("data-stamp");this.del_passenger(n,true);t=n=null},evt_pop_input_focus:function(e){var t=$(e.currentTarget);t.removeClass("warnning")},evt_pop_input:function(e){var t=$(e.currentTarget);t.focus()},evt_combo_click:function(e){var t=$(e.currentTarget);this.proxy.triggerHandler("reset_coupons_val");if(!t.hasClass("readonly")&&!t.hasClass("noStart")&&!t.hasClass("selected")){t.parent().find(".selected").removeClass("selected");t.addClass("selected");var n=t.attr("data-pid");$("#lmpid").val(n);var r=this;if(!r.data[n]){qyerUtil.doAjax({posturl:"/z/?action=ajaxGetCategory",data:{pid:n},__qFED__:{id:"127537c-ccfc-c2b-458b-d3ee13cfeffd",dataIndex:0,randomData:true},onSuccess:function(e){r.data[n]=e.data;for(var i in r.data[n]){if(i=="noDate"){$("#itemDepartBarBar").hide();var s=r.data[n]["noDate"][0];r.setCurr(s);$(".passenger-info-title").hide();$(".passenger-info-wrapper").hide();$("#roomNumBar").hide()}else{$("#itemDepartBarBar").show();$(".passenger-info-title").show();$(".passenger-info-wrapper").show();$("#roomNumBar").hide();r.setCurr(null)}}return false;if(t.attr("data-setoff")=="0"){$("#itemDepartBarBar").hide();$(".lmOrderForm .itemPrice .price em").text(t.attr("data-price"));$(".lmOrderBtns .price em").text("¥"+t.attr("data-price")).attr("data-totle",t.attr("data-price"));$("#amount").attr("max",t.attr("data-remain")).val(1);$("#lmcid").val(t.attr("data-cid"));$("#lmTotPrice").val(t.attr("data-price"))}else{$("#itemDepartBarBar").show();$(".lmOrderForm .itemPrice .price em").text("0");$(".lmOrderBtns .price em").text("¥0").attr("data-totle","0");$("#depart").val("");$("#amount").attr("max","1").val(1);$("#lmcid").val("");$("#lmTotPrice").val("")}},onError:function(e){if(e.__server_error__){require(["slidTip"],function(e){e.show({type:5,text:"服务器错误，请稍后再试！"})})}else{require(["slidTip"],function(t){t.show({type:5,text:e.data.msg||"未知错误"})})}}})}}},change_identityType:function(e){var t,n,r;t=$(e.currentTarget);r=t.parents("li").find(".identityNumber,.identityPlace,.identityValidity");n=t.find("option:selected").val();t.parents(".pass-table-cell").find(".identityNumber").attr("data-validatetype","identityType"+n);if(n=="99"){r.val("").removeClass("required").addClass("disable").prop("readonly",true)}else{r.val("").addClass("required").removeClass("disable").prop("readonly",false)}},evt_add_click:function(e){if(this._curr===null){var t=$(".itemType .combo").filter(".selected").length>0?"请选择产品出发日期":"请选择产品";r(t);return false}var n=$("#amount");var i=$("#roomNum");if(this._curr.stock<=parseInt(n.val())){if(parseInt(n.val())>1){$("#amountNumBox .subtract").removeClass("disable");$("#amountNumBox .add").addClass("disable")}else if(parseInt(n.val())==1){$("#amountNumBox .subtract").addClass("disable");$("#amountNumBox .add").addClass("disable")}r("您选择的商品数量已不足");return false}if(this._curr.buy_limit>0&&this._curr.buy_limit-this._curr.usernum<=parseInt(n.val())){if(parseInt(n.val())>1){$("#amountNumBox .subtract").removeClass("disable");$("#amountNumBox .add").addClass("disable")}else if(parseInt(n.val())==1){$("#amountNumBox .subtract").addClass("disable");$("#amountNumBox .add").addClass("disable")}r("您选择的商品数量超出了购买限制，每个ID限购"+this._curr.buy_limit+"个");return false}var s=parseInt(n.val(),10);$("#amount").val(s+1);if(parseInt(n.val())>1&&this._curr.stock<=parseInt(n.val())){$("#amountNumBox .subtract").removeClass("disable");$("#amountNumBox .add").addClass("disable")}else if(parseInt(n.val())>1&&this._curr.stock>parseInt(n.val())){$("#amountNumBox .subtract").removeClass("disable");$("#amountNumBox .add").removeClass("disable")}var o=parseInt(this._curr.room_type)>0?Math.ceil(parseInt(n.val())/parseInt(this._curr.room_type)):0,u=parseInt(n.val())||0,a=parseInt(i.val())||0;if(i.val()<o){a=a+1;i.val(a);if(a==u){$("#roomNumBox .subtract").addClass("disable");$("#roomNumBox .add").addClass("disable")}else if(a<u){$("#roomNumBox .subtract").addClass("disable");$("#roomNumBox .add").removeClass("disable")}}else if(a==o){$("#roomNumBox .subtract").addClass("disable");$("#roomNumBox .add").removeClass("disable")}else{$("#roomNumBox .subtract").removeClass("disable");$("#roomNumBox .add").removeClass("disable")}this.getPrice(a)},evt_subtract_click:function(e){if(this._curr===null){var t=$(".itemType .combo").filter(".selected").length>0?"请选择产品出发日期":"请选择产品";r(t);return false}var n=$("#amount");var i=$("#roomNum");var s=parseInt(n.val(),10);if(s<=1)return false;n.val(s-1);if(parseInt(n.val())>1){$("#amountNumBox .subtract").removeClass("disable");$("#amountNumBox .add").removeClass("disable")}else if(parseInt(n.val())==1){$("#amountNumBox .subtract").addClass("disable");$("#amountNumBox .add").removeClass("disable")}var o=parseInt(this._curr.room_type)>0?Math.ceil(parseInt(n.val())/parseInt(this._curr.room_type)):0,u=parseInt(n.val())||0,a=parseInt(i.val())||0;if(a>u){a=a-1;i.val(a);if(a==o){$("#roomNumBox .subtract").addClass("disable");$("#roomNumBox .add").addClass("disable")}else if(a>o){$("#roomNumBox .subtract").removeClass("disable");$("#roomNumBox .add").addClass("disable")}}else if(a==u){if(a==o){$("#roomNumBox .subtract").addClass("disable");$("#roomNumBox .add").addClass("disable")}else if(a>o){$("#roomNumBox .subtract").removeClass("disable");$("#roomNumBox .add").addClass("disable")}}else{if(a>o){$("#roomNumBox .subtract").removeClass("disable");$("#roomNumBox .add").removeClass("disable")}else if(a==o){$("#roomNumBox .subtract").removeClass("disable");$("#roomNumBox .add").addClass("disable")}}this.getPrice(a);this.proxy.triggerHandler("reset_coupons_val")},evt_rAdd_click:function(e){if(this._curr===null){var t=$(".itemType .combo").filter(".selected").length>0?"请选择产品出发日期":"请选择产品";r(t);return false}var n=$("#amount"),i=$("#roomNum"),s=parseInt(this._curr.room_type)>0?Math.ceil(parseInt(n.val())/parseInt(this._curr.room_type)):0,o=parseInt(n.val())||0,u=parseInt(i.val())||0;u++;if(u>o){r("房间数已到上限");return false}else if(u==o){i.val(u);$("#roomNumBox .add").addClass("disable");$("#roomNumBox .subtract").removeClass("disable")}else{i.val(u);$("#roomNumBox .add").removeClass("disable");$("#roomNumBox .subtract").removeClass("disable")}this.getPrice(u)},evt_rSubtract_click:function(e){if(this._curr===null){var t=$(".itemType .combo").filter(".selected").length>0?"请选择产品出发日期":"请选择产品";r(t);return false}var n=$("#amount");var i=$("#roomNum");var s=Math.ceil(parseInt(n.val())/this._curr.room_type);var o=parseInt(n.val());var u=parseInt(i.val());u--;if(u<s){r("房间数已达最小值");return false}else if(u==s){i.val(u);$("#roomNumBox .subtract").addClass("disable");$("#roomNumBox .add").removeClass("disable")}else{i.val(u);$("#roomNumBox .subtract").removeClass("disable");$("#roomNumBox .add").removeClass("disable")}this.getPrice(u);this.proxy.triggerHandler("reset_coupons_val")},evt_submitOrder_click:function(e){var t,n,i,s,o;o=this;s=$(".hidden-pass-list");t="";selectedP=$(".itemType .selected");if(!$("#clause").prop("checked")){t+="请阅读并同意《穷游预订条款》、"}if(selectedP.length==0&&t==""){t+="请选择产品类型、"}if($("#itemDepartBarBar:visible").length>0&&$("#depart").val()==""){t+="请选择产品出发日期、"}var u=$("#amount");if($(".passenger-info-wrapper:visible").length>0&&s.length>0){if(s.find("li").length!=parseInt(u.val())&&parseInt(u.val())!=0){t+="旅客信息数量与预定数量不相等、"}else if(s.find("li").length<=0&&parseInt(u.val())!=0){t+="请填写旅客信息、"}}if(t==""&&o._curr.stock<parseInt(u.val())){t+="您选择的商品数量已不足、"}if(t==""&&o._curr.buy_limit>0&&this._curr.buy_limit-this._curr.usernum<parseInt(u.val())){t+="您选择的商品数量超出了购买限制，每个ID限购"+this._curr.buy_limit+"个、"}n=this.validate();if(n!=""&&t==""){t+="请填写正确的"+n}if(t!=""){require(["slidTip"],function(e){e.show({type:5,text:t.slice(0,-1)})})}else{var a="";$.ajax({url:"/z/orderform.php?action=checkorderformstatus",data:{cid:o._curr.cid},dataType:"json",async:false,success:function(e){a=e.data.form_token}});switch(a){case"noinfo":r("没有该产品信息");break;case"wait":o.popupWait();break;case"soldout":o.popupSoldout();break;default:$("#form_token").val(a);$("#orderForm").submit();break}}},popupWait:function(e){var t=this;this.pop.show({type:1,contentHTML:t.popupWaitHtml,onShow:function(){clearTimeout(e);var e=setTimeout(function(){$("#submitOrder").triggerHandler(qyerUtil.EVENT.CLICK)},5e3);$(".lmPopWrapper .lmPopInner .closeWarp").on(qyerUtil.EVENT.CLICK,function(){clearTimeout(e);aPop.hide()})}})},popupSoldout:function(e){var t=this;this.pop.show({type:1,contentHTML:t.popupSoldoutHtml,onShow:function(){$(".lmPopWrapper .lmPopInner a.know").on(qyerUtil.EVENT.CLICK,function(){aPop.hide()})}})},evt_itemIpt_focus:function(e){var t=$(e.currentTarget);t.removeClass("warnning");t.parent().removeClass("warnning");t.attr("placeholder",t.attr("data-placeholder"))},evt_itemIpt_blur:function(e){var t,n;t=$(e.currentTarget);n=this.validate(t);if(n!=""){t.attr("placeholder","请填写正确的"+n)}},evt_textarea_click:function(e){$("body").height($("body").height()+70);$("body,html").scrollTop(9999)},validate:function(e){var t,n;n=[];if(e){switch(e.attr("id")){case"contactName":if(/.+/.test(e.val())==false){n.push("真实姓名");e.addClass("warnning");e.parent().addClass("warnning")}else{e.removeClass("warnning");e.parent().removeClass("warnning")}break;case"contactWechat":if(e.val()&&!/^[a-zA-Z0-9_-]{6,}$/.test(e.val())){n.push("微信号");e.addClass("warnning");e.parent().addClass("warnning")}else{e.removeClass("warnning");e.parent().removeClass("warnning")}break;case"contactPhone":if(/^1[3578]{1}[0-9]{9}$/.test(e.val())==false){n.push("手机号码");e.addClass("warnning");e.parent().addClass("warnning")}else{e.removeClass("warnning");e.parent().removeClass("warnning")}break;case"contactEmail":if(/^(\w|\-)+(\w|\.|\-){0,}@[a-z0-9A-Z]+(\.[a-z0-9A-Z]+){0,}\.[A-Za-z]+$/g.test(e.val())==false){n.push("电子邮箱");e.addClass("warnning");e.parent().addClass("warnning")}else{e.removeClass("warnning");e.parent().removeClass("warnning")}break;case"contactTravelTimeStart":if(e.length&&e.is(":visible")&&!e.val()){n.push("旅行开始时间");e.addClass("warnning");e.parent().addClass("warnning")}else{e.removeClass("warnning");e.parent().removeClass("warnning")}break;case"contactTravelTimeEnd":if(e.length&&e.is(":visible")&&!e.val()){n.push("旅行结束时间");e.addClass("warnning");e.parent().addClass("warnning")}else{e.removeClass("warnning");e.parent().removeClass("warnning")}break}}else{t={name:$("#contactName"),phone:$("#contactPhone"),email:$("#contactEmail"),wechat:$("#contactWechat"),travelTimeStart:$("#contactTravelTimeStart"),travelTimeEnd:$("#contactTravelTimeEnd")};$.each(t,function(e,t){switch(e){case"name":if(/.+/.test(t.val())==false){n.push("真实姓名");t.addClass("warnning");t.parent().addClass("warnning")}else{t.removeClass("warnning");t.parent().removeClass("warnning")}break;case"phone":if(/^1[3578]{1}[0-9]{9}$/.test(t.val())==false){n.push("手机号码");t.addClass("warnning");t.parent().addClass("warnning")}else{t.removeClass("warnning");t.parent().removeClass("warnning")}break;case"email":if(/^(\w|\-)+(\w|\.|\-){0,}@[a-z0-9A-Z]+(\.[a-z0-9A-Z]+){0,}\.[A-Za-z]+$/g.test(t.val())==false){n.push("电子邮箱");t.addClass("warnning");t.parent().addClass("warnning")}else{t.removeClass("warnning");t.parent().removeClass("warnning")}break;case"wechat":if(t.val()&&!/^[a-zA-Z0-9_-]{6,}$/.test(t.val())){n.push("微信号");t.addClass("warnning");t.parent().addClass("warnning")}else{t.removeClass("warnning");t.parent().removeClass("warnning")}break;case"travelTimeStart":if(t.length&&t.is(":visible")&&!t.val()){n.push("旅行开始时间");t.addClass("warnning");t.parent().addClass("warnning")}else{t.removeClass("warnning");t.parent().removeClass("warnning")}break;case"travelTimeEnd":if(t.length&&t.is(":visible")&&!t.val()){n.push("旅行结束时间");t.addClass("warnning");t.parent().addClass("warnning")}else{t.removeClass("warnning");t.parent().removeClass("warnning")}break}})}if(n.length>0){return n.join(",")}else{return""}}};if($("#orderMain").length){n.init();$("#lmTotPrice").change(function(){if($(this).val()<=0){$("#roomOffset").hide();$("#roomOffsetBar2").hide()}$(".lmOrderBtns em").html("¥"+$(this).val())});function r(e){require(["popup_base","slidTip"],function(t,n){n.show({type:5,text:e})})}var i={endTimes:[],nowTime:0,init:function(){this.num=s.length;for(var e=0;e<this.num;e++){this.endTimes[e]=parseInt(s.eq(e).attr("data-time"))}this.giveTime()},giveTime:function(){var e=this;if(window.ActiveXObject){http_request=new ActiveXObject("Microsoft.XMLHTTP")}else if(window.XMLHttpRequest){http_request=new XMLHttpRequest}http_request.open("HEAD","/ajax.php",false);http_request.send(null);var t=new Date(http_request.getResponseHeader("Date"));if(typeof t!="undefined"){this.nowTime=t.getTime()}else{var n=new Date;this.nowTime=n.getTime()}this.nowTime=Math.floor(this.nowTime/1e3);this.downCount()},downCount:function(){var e=this;this.nowTime=this.nowTime+1;for(var t=0;t<this.num;t++){var n=s.eq(t);var r=this.endTimes[t];r=r++;if(r<=this.nowTime){n.parent(".combo").removeClass("noStart");if(n.html()!=""){n.before("剩余"+n.attr("data-stock"));n.html("")}}else{var i=r-this.nowTime;this.timeChange(i,n)}}window.setTimeout(function(){e.downCount()},1e3)},timeChange:function(e,t){var n=e/3600;var r=e%3600/60;var i=e%60;n=Math.floor(n);r=Math.floor(r);var s=t.find("em");s.eq(0).text(n);s.eq(1).text(r);s.eq(2).text(i)}};var s=$(".seckillTime");if(s.length>0){i.init()}}})